name: CI

on:
  push:
    branches: ['**']
  pull_request:

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-check:
    name: Build & Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    env:
      CI: true
      NEXT_TELEMETRY_DISABLED: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Composite setup (node, cache, deps)
      - uses: ./.github/actions/setup

      # Sanity-check native bindings
      - name: Verify sharp binding
        env:
          SHARP_IGNORE_GLOBAL_LIBVIPS: '1'
        run: |
          node -p "process.platform + ' ' + process.arch"
          node -e "require('sharp'); console.log('sharp: OK')"

      - name: Rebuild native addons (lightningcss + sharp)
        env:
          npm_config_platform: linux
          npm_config_arch: x64
          SHARP_IGNORE_GLOBAL_LIBVIPS: '1'
        run: |
          npm rebuild lightningcss --foreground-scripts
          npm rebuild sharp --foreground-scripts

      # Full CI pipeline (lint, images, checks, build)
      # Provide harmless env so Next/Auth never crash during *build time*
      - name: Run CI pipeline
        env:
          DATABASE_URL: postgresql://dummy:dummy@127.0.0.1:5432/dummy?sslmode=disable&options=-c%20search_path%3Dauth%2Cdojo%2Cpublic
          NEXTAUTH_URL: http://localhost:3000
          AUTH_SECRET: ci-dummy
          GOOGLE_CLIENT_ID: ci-dummy
          GOOGLE_CLIENT_SECRET: ci-dummy
        run: npm run ci --if-present

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      NEXT_TELEMETRY_DISABLED: 1
      PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      PLAYWRIGHT_USE_SYSTEM_CHROME: '0'
      # Make the dev server (spawned by Playwright) see a DB and allow protected-route bypass
      VERCEL_ENV: preview
      DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}   # add this in repo settings → Secrets and variables → Actions
      NEXTAUTH_URL: http://localhost:3000
      AUTH_SECRET: ci-dummy
      GOOGLE_CLIENT_ID: ci-dummy
      GOOGLE_CLIENT_SECRET: ci-dummy
      AUTH_RULES_JSON: '{"ownerDomains":["tullyelly.com"],"publicPaths":["/","/login","/api/auth"],"protectedPaths":["/shaolin-scrolls","/admin"],"ownerOnlyPaths":["/shaolin-scrolls/admin"],"toggles":{"allowAnyEmailOnPreview":true}}'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(npx @playwright/test --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit != 'true' && env.PLAYWRIGHT_USE_SYSTEM_CHROME != '1'
        run: npx playwright install-deps chromium

      - name: Install Playwright Chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true' && env.PLAYWRIGHT_USE_SYSTEM_CHROME != '1'
        run: npx playwright install chromium

      - name: Install system Chromium (fallback)
        if: env.PLAYWRIGHT_USE_SYSTEM_CHROME == '1'
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser || sudo apt-get install -y chromium

      - name: Run e2e tests
        run: npx playwright test --reporter=html

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report
          path: playwright-report

      - name: Upload Playwright traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/**/trace.zip