name: CI

on:
  push:
    branches: ["**"] # fast feedback on all branches
  pull_request:
    branches: [main] # full suite when proposing changes to main
  schedule:
    - cron: "0 6 * * 1"

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-check:
    name: Build & Check
    runs-on: ubuntu-latest # keep Linux to match Playwright snapshot baselines; approve new baselines per-OS if you change this
    timeout-minutes: 30
    outputs:
      run_e2e: ${{ steps.filter.outputs.e2e }}
    env:
      CI: true
      NEXT_TELEMETRY_DISABLED: 1
      NODE_ENV: test
      TEST_DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
      DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
      NEXT_PUBLIC_E2E_STABLE: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # required for format diffing against main

      # Composite setup (node, cache, deps)
      - uses: ./.github/actions/setup

      - name: Secrets scan (Secretlint)
        run: npm run secrets:scan

      - name: Generate build info
        run: npm run gen:build-info

      - name: Cache Next.js artifacts
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            .contentlayer
            node_modules/.cache
          key: ${{ runner.os }}-next-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-next-

      # Skip heavy work when irrelevant
      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            images:
              - 'public/**/*'
              - '**/*.{png,jpg,jpeg,webp,avif,svg,gif}'
            native:
              - 'package.json'
              - 'package-lock.json'
              - 'scripts/**'
            content:
              - 'content/**/*'
              - 'docs/**/*'
              - '**/*.md'
              - '**/*.mdx'
            seo:
              - 'content/**/*'
              - 'docs/**/*'
              - 'app/**/*.{ts,tsx,js,jsx,md,mdx}'
              - 'lib/seo/**'
              - 'next.config.mjs'
            security:
              - 'next.config.mjs'
              - 'auth.ts'
              - 'lib/security/**'
              - 'app/api/**'
            build:
              - 'app/**'
              - 'components/**'
              - 'lib/**'
              - 'pages/**'
              - 'public/**/*'
              - 'next.config.mjs'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
              - 'tailwind.config.mjs'
              - 'postcss.config.mjs'
              - 'auth.ts'
            e2e:
              - 'app/**'
              - 'components/**'
              - 'lib/**'
              - 'pages/**'
              - 'e2e/**'
              - 'playwright.config.*'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
              - 'next.config.mjs'
              - 'auth.ts'

      # Native addon sanity only when it matters (native deps changed or on main)
      - name: Verify sharp binding
        if: github.ref_name == 'main' || steps.filter.outputs.native == 'true'
        env:
          SHARP_IGNORE_GLOBAL_LIBVIPS: "1"
        run: |
          node -p "process.platform + ' ' + process.arch"
          node -e "require('sharp'); console.log('sharp: OK')"

      - name: Rebuild native addons (lightningcss + sharp)
        if: github.ref_name == 'main' || steps.filter.outputs.native == 'true'
        env:
          npm_config_platform: linux
          npm_config_arch: x64
          SHARP_IGNORE_GLOBAL_LIBVIPS: "1"
        run: |
          npm rebuild lightningcss --foreground-scripts
          npm rebuild sharp --foreground-scripts

      # Split the CI pipeline so we can selectively skip heavy steps
      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Metadata coverage (strict)
        run: SEO_METADATA_ENFORCE=strict npm run lint:metadata

      - name: Format check
        run: npm run format:check

      - name: Unit tests
        run: npm run test:ci

      - name: Coverage gate
        env:
          COVERAGE_MINIMUM: "80"
        run: npm run coverage:check

      - name: Upload coverage summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: coverage/coverage-summary.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Optimize images (changed only)
        if: steps.filter.outputs.images == 'true'
        run: npm run images:optimize

      - name: Images check (changed only)
        if: steps.filter.outputs.images == 'true'
        run: npm run images:check

      - name: Validate frontmatter
        if: github.event_name == 'schedule' || github.ref_name == 'main' || steps.filter.outputs.content == 'true'
        run: npm run validate-frontmatter

      - name: Validate SEO
        if: github.event_name == 'schedule' || github.ref_name == 'main' || steps.filter.outputs.seo == 'true'
        run: npm run validate-seo

      - name: Cache Playwright browsers
        if: github.event_name == 'schedule' || github.ref_name == 'main' || steps.filter.outputs.seo == 'true'
        uses: actions/cache@v4
        with:
          path: .pw-browsers
          key: pw-${{ runner.os }}-chromium-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers (chromium only)
        if: github.event_name == 'schedule' || github.ref_name == 'main' || steps.filter.outputs.seo == 'true'
        run: PLAYWRIGHT_BROWSERS_PATH=.pw-browsers npx playwright install --with-deps chromium

      - name: SEO smoke tests
        if: github.event_name == 'schedule' || github.ref_name == 'main' || steps.filter.outputs.seo == 'true'
        run: npm run test:seo

      - name: Build
        if: github.event_name == 'schedule' || github.ref_name == 'main' || steps.filter.outputs.build == 'true' || steps.filter.outputs.security == 'true'
        # harmless env so Next/Auth won't crash during build
        env:
          DATABASE_URL: postgresql://dummy:dummy@127.0.0.1:5432/dummy?sslmode=disable&options=-c%20search_path%3Dauth%2Cdojo%2Cpublic
          NEXTAUTH_URL: http://localhost:3000
          AUTH_SECRET: ci-dummy
          GOOGLE_CLIENT_ID: ci-dummy
          GOOGLE_CLIENT_SECRET: ci-dummy
          NODE_OPTIONS: "--max-old-space-size=4096"
          NEXT_TELEMETRY_DISABLED: "1"
          CI: "true"
        run: npm run build --silent

      - name: Start Next and wait
        if: github.event_name == 'schedule' || github.ref_name == 'main' || steps.filter.outputs.security == 'true'
        env:
          NODE_ENV: production
          PORT: 4010
          NEXTAUTH_URL: http://127.0.0.1:4010
          NEXTAUTH_SECRET: ci-secret
          SKIP_DB: "true"
        run: |
          npx kill-port 4010 || true
          npm run start:ci > .next/ci-server.log 2>&1 &
          npx wait-on --httpTimeout 10000 --timeout 120000 http://127.0.0.1:4010/api/health

      - name: Security headers check
        if: github.event_name == 'schedule' || github.ref_name == 'main' || steps.filter.outputs.security == 'true'
        env:
          PORT: 4010
        run: npm run security-headers:check -- "http://127.0.0.1:${PORT}/"

      - name: Stop Next
        if: always() && (github.event_name == 'schedule' || github.ref_name == 'main' || steps.filter.outputs.security == 'true')
        run: npx kill-port 4010 || true

      - name: Print logs on failure
        if: failure()
        run: |
          echo "---- .next/ci-server.log ----"
          tail -n +1 .next/ci-server.log || true

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest # align with local (Linux) snapshots; add per-OS baselines if changing
    timeout-minutes: 15
    needs: build-and-check
    if: (github.event_name == 'pull_request' || github.ref_name == 'main') && (github.ref_name == 'main' || needs.build-and-check.outputs.run_e2e == 'true')
    env:
      NODE_ENV: test
      NEXT_TELEMETRY_DISABLED: 1
      VERCEL_ENV: preview
      # point Playwright to the repo-local cache so snapshots stay consistent
      PLAYWRIGHT_BROWSERS_PATH: .pw-browsers

      # your app env
      DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
      NEXTAUTH_URL: http://localhost:3000
      AUTH_SECRET: ci-dummy
      GOOGLE_CLIENT_ID: ci-dummy
      GOOGLE_CLIENT_SECRET: ci-dummy
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: ./.github/actions/setup

      # grab the local @playwright/test version for cache keying
      - name: Get Playwright version
        id: pw
        shell: bash
        run: |
          echo "version=$(node -e 'console.log(require(\"@playwright/test/package.json\").version)')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: .pw-browsers
          key: ${{ runner.os }}-pw-${{ steps.pw.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-pw-

      # ðŸŒŸ New: install browsers + OS deps via CLI (works on Ubuntu 24.04)
      # Specify chromium to keep it lean; drop "chromium" to install all browsers.
      - name: Install Playwright (browsers + OS deps)
        run: npx playwright install --with-deps chromium

      - name: Build (deterministic for E2E)
        run: npm run build:test

      - name: Run E2E tests
        env:
          NEXT_PUBLIC_E2E: "true"
          NEXT_TELEMETRY_DISABLED: "1"
        run: npx playwright test --reporter=html

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report
          path: playwright-report

      - name: Upload Playwright traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/**/trace.zip
